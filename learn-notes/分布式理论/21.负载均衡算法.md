# 负载均衡算法

## 常见的负载均衡算法包含：
1. 轮询法（Round Robin）
2. 加权轮询法（Weight Round Robin）
3. 随机法（Random）
4. 加权随机法（Weight Random）
5. 平滑加权轮询法（Smooth Weight Round Robin）
6. 源地址哈希法（Hash）
7. 最小连接数法（Least Connections）


## 算法详解

### 随机法 Random
> 将请求随机分发给服务器，无状态的，完全随机是最简单的负载均衡算法了，
>缺点比较明显，因为服务器有好有坏，处理能力是不同的，我们希望性能好的服务器多处理些请求，性能差的服务器少处理一些请求，所以就有了加权随机。


### 加权随机 Weight Random
> 加权随机，虽然还是采用的随机算法，但是为每台服务器设置了权重，权重大的服务器获得的概率大一些，权重小的服务器获得的概率小一些。

>> 如果A服务器的权重是2，B服务器的权重是7，C服务器的权重是1：
   如果我生成的随机数是1，那么落到A服务器，因为1<=2（A服务器的权重）
   如果我生成的随机数是5，那么落到B服务器，因为5>2（A服务器的权重），5-2（A服务器的权重）=3，3<7（B服务器的权重）
   如果我生成的随机数是10，那么落到C服务器，因为10>2（A服务器的权重），10-2（A服务器的权重）=8，8>7（B服务器的权重），8-7（B服务器的权重）=1，
   1<=1（C服务器的权重）
   
### 完全轮询 Round Robin
> 完全轮询，也是比较简单的，但是问题和完全随机是一样的，所以出现了加权轮询。
### 加权轮询 Weight Round Robin
> 加权轮询还是有两种常用的实现方式，和加权随机是一样的
> 加权轮询，看起来并没什么问题，但是还是有一点瑕疵，其中一台服务器的压力可能会突然上升，而另外的服务器却很“悠闲，喝着咖啡，看着新闻”。我们希望虽然是按照轮询，但是中间最好可以有交叉，所以出现了第三种轮询算法：平滑加权轮询。
### 平滑加权轮询 Smooth Weight Round Robin
> 平滑加权是一个算法
> 比如A服务器的权重是5，B服务器的权重是1，C服务器的权重是1。
> 这个权重，我们称之为“固定权重”，既然这个叫“固定权重”，那么肯定还有叫“非固定权重的”，没错，“非固定权重”每次都会根据一定的规则变动。

> 第一次访问，ABC的“非固定权重”分别是 5 1 1（初始），因为5是其中最大的，5对应的就是A服务器，所以这次选到的服务器就是A，然后我们用当前被选中的服务器的权重-各个服务器的权重之和，也就是A服务器的权重-各个服务器的权重之和。也就是5-7=-2，没被选中的服务器的“非固定权重”不做变化，现在三台服务器的“非固定权重”分别是-2 1 1。
  第二次访问，把第一次访问最后得到的“非固定权重”+“固定权重”，现在三台服务器的“非固定权重”是3，2，2，因为3是其中最大的，3对应的就是A服务器，所以这次选到的服务器就是A，然后我们用当前被选中的服务器的权重-各个服务器的权重之和，也就是A服务器的权重-各个服务器的权重之和。也就是3-7=-4，没被选中的服务器的“非固定权重”不做变化，现在三台服务器的“非固定权重”分别是-4 1 1。
  第三次访问，把第二次访问最后得到的“非固定权重”+“固定权重”，现在三台服务器的“非固定权重”是1，3，3，这个时候3虽然是最大的，但是却出现了两个，我们选第一个，第一个3对应的就是B服务器，所以这次选到的服务器就是B，然后我们用当前被选中的服务器的权重-各个服务器的权重之和，也就是B服务器的权重-各个服务器的权重之和。也就是3-7=-4，没被选中的服务器的“非固定权重”不做变化，现在三台服务器的“非固定权重”分别是1 -4 3。
> 这就是平滑加权轮询，巧妙的利用了巧妙算法，既有轮询的效果，又避免了某台服务器压力突然升高，不可谓不妙。
### 哈希 Hash
> 负载均衡算法中的哈希算法，就是根据某个值生成一个哈希值，然后对应到某台服务器上去，当然可以根据用户，也可以根据请求参数，或者根据其他，想怎么来就怎么来。如果根据用户，就比较巧妙的解决了负载均衡下Session共享的问题，用户小明走的永远是A服务器，用户小笨永远走的是B服务器。
> 一致性Hash、Hash环

### 最小压力
> 所以的最小压力负载均衡算法就是 选择一台当前最“悠闲”的服务器，如果A服务器有100个请求，B服务器有5个请求，而C服务器只有3个请求，那么毫无疑问会选择C服务器，这种负载均衡算法是比较科学的。但是遗憾的在当前的场景下无法模拟出来“原汁原味”的最小压力负载均衡算法的。
  当然在实际的负载均衡下，可能会将多个负载均衡算法合在一起实现，比如先根据最小压力算法，当有几台服务器的压力一样小的时候，再根据权重取出一台服务器，如果权重也一样，再随机取一台，等等。
